@model SportZone_API.DTOs.FacilityDetailDto
@{ 
    var evaluationTime = ViewData["ScheduleEvaluationTime"] as DateTime? ?? DateTime.Now;
    var schedule = FacilityScheduleHelper.Evaluate(Model.OpenTime, Model.CloseTime, evaluationTime);
    var statusClass = schedule.IsOpen
        ? "badge-soft-success"
        : schedule.HasSchedule ? "badge-soft-danger" : "badge-soft-secondary";
    var statusIcon = schedule.IsOpen
        ? "fa-door-open"
        : schedule.HasSchedule ? "fa-door-closed" : "fa-clock";
    var statusLabel = schedule.Is24Hours
        ? "Hoạt động 24/7"
        : schedule.IsOpen ? "Đang mở" : schedule.HasSchedule ? "Đang đóng" : "Đang cập nhật";
    var nextChange = schedule.NextChangeTime;
    var statusMeta = schedule.HasSchedule
        ? schedule.Is24Hours
            ? "Phục vụ suốt tuần"
            : schedule.IsOpen
                ? nextChange.HasValue
                    ? $"Đóng lúc {nextChange.Value:HH\\:mm}" + (schedule.NextChangeIsTomorrow ? " (ngày mai)" : string.Empty)
                    : "Thời gian đóng cửa đang cập nhật"
                : nextChange.HasValue
                    ? $"Mở lại {(schedule.NextChangeIsTomorrow ? "ngày mai " : string.Empty)}lúc {nextChange.Value:HH\\:mm}"
                    : "Thời gian mở cửa đang cập nhật"
        : "Giờ mở cửa sẽ được cập nhật sớm";
    var imageUrl = Model.ImageUrls?.FirstOrDefault(url => !string.IsNullOrWhiteSpace(url))
        ?? Url.Content("~/images/placeholder-facility.svg");
    var openTime = Model.OpenTime?.ToString("HH\\:mm") ?? "--:--";
    var closeTime = Model.CloseTime?.ToString("HH\\:mm") ?? "--:--";
    var categories = Model.CategoryFields ?? new List<SportZone_API.DTOs.CategoryFieldDto>();
    var featuredCategories = categories
        .Where(category => !string.IsNullOrWhiteSpace(category?.CategoryFieldName))
        .Take(3)
        .ToList();
    var remainingCategoryCount = Math.Max(0, categories.Count - featuredCategories.Count);
    var hasDescription = !string.IsNullOrWhiteSpace(Model.Description);
    var request = Context?.Request;
    var shareUrl = request?.Host.HasValue == true
        ? Url.Page("/Facilities/Details", pageHandler: null, values: new { id = Model.FacId }, protocol: request!.Scheme, host: request.Host.Value)
        : Url.Page("/Facilities/Details", pageHandler: null, values: new { id = Model.FacId });
    shareUrl ??= Url.Page("/Facilities/Details", pageHandler: null, values: new { id = Model.FacId }) ?? string.Empty;
    var shareTitle = !string.IsNullOrWhiteSpace(Model.Name) ? Model.Name : "Cơ sở thể thao SportZone";
    var shareText = !string.IsNullOrWhiteSpace(Model.Address)
        ? $"Khám phá {Model.Name ?? "cơ sở thể thao"} tại {Model.Address} trên SportZone."
        : $"Khám phá {Model.Name ?? "cơ sở thể thao"} trên SportZone.";
    var directionsQuerySource = !string.IsNullOrWhiteSpace(Model.Address) ? Model.Address : Model.Name;
    directionsQuerySource = directionsQuerySource?.Trim();
    var directionsQuery = string.IsNullOrWhiteSpace(directionsQuerySource) ? "SportZone" : directionsQuerySource!;
    var directionsUrl = $"https://www.google.com/maps/search/?api=1&query={Uri.EscapeDataString(directionsQuery)}";
}

<article class="facility-card h-100">
    <img class="facility-card__image" src="@imageUrl" alt="@Model.Name" loading="lazy" />
    <div class="p-4 d-flex flex-column gap-3 h-100">
        <header>
            <h2 class="h5 mb-1">@Model.Name</h2>
            @if (!string.IsNullOrWhiteSpace(Model.Address))
            {
                <p class="text-muted mb-0"><i class="fa-solid fa-location-dot me-2 text-danger"></i>@Model.Address</p>
            }
        </header>

        <div class="facility-card__badges d-flex flex-wrap">
            <span class="badge @statusClass"><i class="fa-solid @statusIcon me-1"></i>@statusLabel</span>
            <span class="badge badge-soft-primary"><i class="fa-regular fa-clock me-1"></i>@openTime - @closeTime</span>
            <span class="badge badge-soft-success">@categories.Count hạng mục</span>
        </div>

        <p class="facility-card__status-meta text-muted small mb-0">@statusMeta</p>

        @if (hasDescription)
        {
            <p class="facility-card__description mb-0">@Model.Description</p>
        }

        @if (featuredCategories.Any())
        {
            <div>
                <h3 class="h6 text-uppercase text-muted mb-2">Hạng mục nổi bật</h3>
                <div class="d-flex flex-wrap gap-2">
                    @foreach (var category in featuredCategories)
                    {
                        <span class="badge facility-card__category">@category.CategoryFieldName</span>
                    }
                    @if (remainingCategoryCount > 0)
                    {
                        <span class="badge facility-card__category">+@remainingCategoryCount</span>
                    }
                </div>
            </div>
        }

        <footer class="facility-card__footer mt-auto pt-3 border-top d-flex flex-column gap-3">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <span class="text-muted small"><i class="fa-solid fa-layer-group me-1"></i>@categories.Count hạng mục</span>
                <a class="btn btn-sm btn-outline-primary" asp-page="/Facilities/Details" asp-route-id="@Model.FacId">
                    Xem chi tiết
                </a>
            </div>
            <div class="facility-card__actions">
                <a class="btn btn-sm btn-outline-success" href="@directionsUrl" target="_blank" rel="noopener">
                    <i class="fa-solid fa-map-location-dot me-1"></i>Chỉ đường
                </a>
                <button type="button"
                        class="btn btn-sm btn-outline-secondary share-trigger"
                        data-share-url="@shareUrl"
                        data-share-title="@shareTitle"
                        data-share-text="@shareText"
                        data-share-success-label="Đã sao chép!"
                        data-share-reset-label="Chia sẻ">
                    <i class="fa-solid fa-share-nodes me-1"></i>
                    <span class="share-trigger__label">Chia sẻ</span>
                </button>
            </div>
        </footer>
    </div>
</article>
