@page "/staff-manager"

<PageTitle>Quản lý nhân viên - SportZone</PageTitle>

<div class="admin-page staff-manager">
    <div class="admin-header">
        <div>
            <h1>Quản lý nhân viên</h1>
            <p class="subtitle">Theo dõi đội ngũ hỗ trợ tại cơ sở và cập nhật trạng thái làm việc.</p>
        </div>
        <div class="staff-manager__actions">
            <button class="btn btn-primary" disabled title="Tính năng đang phát triển">+ Mời nhân viên</button>
        </div>
    </div>

    <div class="staff-toolbar">
        <div class="search-input-wrapper">
            <input type="search"
                   placeholder="Tìm theo tên, số điện thoại hoặc cơ sở"
                   @bind="_searchTerm"
                   @bind:event="oninput"
                   class="search-input" />
            @if (!string.IsNullOrWhiteSpace(_searchTerm))
            {
                <button type="button" class="clear-search" @onclick="ClearSearch">✕</button>
            }
        </div>
        <label class="filter-select">
            <span>Trạng thái</span>
            <select @bind="_statusFilter">
                <option value="all">Tất cả</option>
                <option value="active">Đang làm việc</option>
                <option value="inactive">Tạm nghỉ</option>
            </select>
        </label>
    </div>

    <div class="stats-grid staff-manager__stats">
        <div class="stat-card">
            <span class="stat-label">Tổng nhân viên</span>
            <span class="stat-value">@_staff.Count</span>
            <span class="stat-change">Hiển thị @Filtered.Count() nhân viên</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Đang làm việc</span>
            <span class="stat-value">@_staff.Count(s => s.Status == StaffStatus.Active)</span>
            <span class="stat-change positive">@GetActivePercentage()% hoạt động</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Số cơ sở</span>
            <span class="stat-value">@_staff.SelectMany(s => s.FacilityNames).Distinct().Count()</span>
            <span class="stat-change">Phân bổ theo cơ sở</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Thời gian trung bình</span>
            <span class="stat-value">@GetAverageTenure()</span>
            <span class="stat-change">Kể từ ngày gia nhập</span>
        </div>
    </div>

    <div class="staff-table-wrapper">
        @if (!Filtered.Any())
        {
            <div class="staff-empty">Không tìm thấy nhân viên phù hợp với tiêu chí lọc.</div>
        }
        else
        {
            <table class="staff-table">
                <thead>
                    <tr>
                        <th>Nhân viên</th>
                        <th>SĐT</th>
                        <th>Email</th>
                        <th>Cơ sở phụ trách</th>
                        <th>Ngày tham gia</th>
                        <th>Trạng thái</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var staff in Filtered)
                    {
                        <tr>
                            <td>
                                <div class="staff-info">
                                    <div class="avatar">@staff.Initials</div>
                                    <div>
                                        <span class="name">@staff.Name</span>
                                        <span class="role">@staff.Role</span>
                                    </div>
                                </div>
                            </td>
                            <td>@staff.Phone</td>
                            <td>@staff.Email</td>
                            <td>@string.Join(", ", staff.FacilityNames)</td>
                            <td>@staff.StartDate.ToString("dd/MM/yyyy")</td>
                            <td>
                                <span class="status-badge @(staff.Status == StaffStatus.Active ? "status-badge--success" : "status-badge--muted")">
                                    @(staff.Status == StaffStatus.Active ? "Đang làm việc" : "Tạm nghỉ")
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

@code {
    private readonly List<StaffRecord> _staff =
    [
        new("Nguyễn Minh Khoa", "0355 123 456", "khoa.nguyen@sportzone.vn", StaffStatus.Active, DateOnly.FromDateTime(DateTime.Today.AddYears(-2)), new[] { "SportZone Quận 1" }, "Quản lý ca"),
        new("Lê Thị Thuỷ", "0378 222 333", "thuy.le@sportzone.vn", StaffStatus.Active, DateOnly.FromDateTime(DateTime.Today.AddMonths(-14)), new[] { "SportZone Quận 1", "SportZone Thủ Đức" }, "Điều phối viên"),
        new("Trần Hữu Phúc", "0903 456 789", "phuc.tran@sportzone.vn", StaffStatus.Inactive, DateOnly.FromDateTime(DateTime.Today.AddMonths(-30)), new[] { "SportZone Quận 7" }, "Nhân viên kỹ thuật"),
        new("Phạm Quốc Huy", "0912 888 777", "huy.pham@sportzone.vn", StaffStatus.Active, DateOnly.FromDateTime(DateTime.Today.AddMonths(-7)), new[] { "SportZone Quận 1" }, "Lễ tân"),
        new("Đỗ Kim Ngân", "0987 654 321", "ngan.do@sportzone.vn", StaffStatus.Active, DateOnly.FromDateTime(DateTime.Today.AddMonths(-20)), new[] { "SportZone Thủ Đức" }, "Hỗ trợ khách hàng")
    ];

    private string _searchTerm = string.Empty;
    private string _statusFilter = "all";

    private IEnumerable<StaffRecord> Filtered => _staff
        .Where(MatchesStatus)
        .Where(MatchesSearch);

    private void ClearSearch()
    {
        _searchTerm = string.Empty;
    }

    private bool MatchesStatus(StaffRecord staff) => _statusFilter switch
    {
        "active" => staff.Status == StaffStatus.Active,
        "inactive" => staff.Status == StaffStatus.Inactive,
        _ => true
    };

    private bool MatchesSearch(StaffRecord staff)
    {
        if (string.IsNullOrWhiteSpace(_searchTerm))
        {
            return true;
        }

        var term = _searchTerm.Trim();
        return staff.Name.Contains(term, StringComparison.OrdinalIgnoreCase)
            || staff.Phone.Contains(term, StringComparison.OrdinalIgnoreCase)
            || staff.Email.Contains(term, StringComparison.OrdinalIgnoreCase)
            || staff.FacilityNames.Any(name => name.Contains(term, StringComparison.OrdinalIgnoreCase));
    }

    private int GetActivePercentage()
        => _staff.Count == 0 ? 0 : (int)Math.Round((double)_staff.Count(s => s.Status == StaffStatus.Active) / _staff.Count * 100);

    private string GetAverageTenure()
    {
        if (_staff.Count == 0)
        {
            return "--";
        }

        var totalDays = _staff.Sum(staff => (DateTime.Today - staff.StartDate.ToDateTime(TimeOnly.MinValue)).TotalDays);
        var averageDays = totalDays / _staff.Count;

        if (averageDays < 30)
        {
            return $"{averageDays:0} ngày";
        }

        var months = averageDays / 30.4375;
        return months >= 12 ? $"~{months / 12:0.#} năm" : $"~{months:0.#} tháng";
    }

    private enum StaffStatus
    {
        Active,
        Inactive
    }

    private sealed record StaffRecord(string Name, string Phone, string Email, StaffStatus Status, DateOnly StartDate, IEnumerable<string> FacilityNames, string Role)
    {
        public IEnumerable<string> FacilityNames { get; } = FacilityNames;
        public string Role { get; } = Role;
        public string Initials => string.Join(string.Empty, Name.Split(' ', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).Take(2).Select(part => part[0])).ToUpperInvariant();
    }
}
