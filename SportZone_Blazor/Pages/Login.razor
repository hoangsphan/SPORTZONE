@page "/login"
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IAuthService AuthService

<PageTitle>Đăng nhập - SportZone</PageTitle>

<div class="auth-page">
    <!-- Header -->
    <AppHeader />

    <!-- Main Content -->
    <div class="auth-container">
        <!-- Left Side - Form -->
        <div class="auth-left">
            <div class="auth-form-container">
                <div class="auth-title">
                    <h1>Chào mừng bạn đến với SportZone</h1>
                </div>

                <div class="auth-tabs">
                    <button class="auth-tab @(_activeTab == "signin" ? "active" : "")" 
                            @onclick="@(() => SetActiveTab("signin"))">
                        Đăng nhập
                    </button>
                    <button class="auth-tab @(_activeTab == "register" ? "active" : "")" 
                            @onclick="@(() => SetActiveTab("register"))">
                        Đăng ký
                    </button>
                </div>

                <div class="auth-form-box">
                    @if (_activeTab == "signin")
                    {
                        <form class="auth-form" @onsubmit="HandleSignIn" @onsubmit:preventDefault>
                            <div class="form-group">
                                <label>E-mail</label>
                                <input type="email" 
                                       @bind="_email" 
                                       placeholder="example@gmail.com" 
                                       class="form-control" 
                                       required />
                            </div>

                            <div class="form-group">
                                <label>Mật khẩu</label>
                                <div class="password-input">
                                    <input type="@(_showPassword ? "text" : "password")"
                                           @bind="_password"
                                           placeholder="Nhập mật khẩu"
                                           class="form-control"
                                           required />
                                    <button type="button"
                                            class="password-toggle"
                                            @onclick="TogglePassword">
                                        @if (_showPassword)
                                        {
                                            <span>Ẩn</span>
                                        }
                                        else
                                        {
                                            <span>Hiện</span>
                                        }
                                    </button>
                                </div>
                            </div>

                            <div class="form-options">
                                <label class="remember-me">
                                    <input type="checkbox" @bind="_rememberMe" />
                                    <span>Nhớ mật khẩu</span>
                                </label>
                                <button type="button" class="forgot-password" @onclick="ShowForgotPassword">
                                    Quên mật khẩu?
                                </button>
                            </div>

                            <button type="submit" class="btn-submit" disabled="@_loading">
                                @(_loading ? "Đang đăng nhập..." : "Đăng nhập")
                            </button>

                            <button type="button" class="btn-google" @onclick="HandleGoogleLogin" disabled="@_loading">
                                <span>@(_loading ? "Đợi một chút..." : "Đăng nhập với Google")</span>
                            </button>
                        </form>
                    }
                    else
                    {
                        <form class="auth-form" @onsubmit="HandleRegister" @onsubmit:preventDefault>
                            @if (!string.IsNullOrEmpty(_registerErrorMessage))
                            {
                                <div class="error-message">
                                    @_registerErrorMessage
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(_registerSuccessMessage))
                            {
                                <div class="success-message">
                                    @_registerSuccessMessage
                                </div>
                            }

                            <div class="form-group">
                                <label>Vai trò</label>
                                <select @bind="_registerRoleName" class="form-control" required>
                                    <option value="">Chọn vai trò</option>
                                    <option value="Customer">Khách hàng</option>
                                    <option value="Field_Owner">Chủ sân</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Họ và tên</label>
                                <input type="text" 
                                       @bind="_registerName" 
                                       placeholder="Nhập họ và tên" 
                                       class="form-control" 
                                       required />
                            </div>

                            <div class="form-group">
                                <label>Số điện thoại</label>
                                <input type="tel" 
                                       @bind="_registerPhone" 
                                       placeholder="Nhập số điện thoại" 
                                       class="form-control" 
                                       required />
                            </div>

                            <div class="form-group">
                                <label>E-mail</label>
                                <input type="email" 
                                       @bind="_registerEmail" 
                                       placeholder="example@gmail.com" 
                                       class="form-control" 
                                       required />
                            </div>

                            <div class="form-group">
                                <label>Mật khẩu</label>
                                <div class="password-input">
                                    <input type="@(_showRegisterPassword ? "text" : "password")"
                                           @bind="_registerPassword"
                                           placeholder="Nhập mật khẩu (tối thiểu 10 ký tự)"
                                           class="form-control"
                                           required />
                                    <button type="button"
                                            class="password-toggle"
                                            @onclick="ToggleRegisterPassword">
                                        @if (_showRegisterPassword)
                                        {
                                            <span>Ẩn</span>
                                        }
                                        else
                                        {
                                            <span>Hiện</span>
                                        }
                                    </button>
                                </div>
                                <small class="password-hint">Mật khẩu phải có ít nhất 10 ký tự, bao gồm chữ hoa, chữ thường, số và ký tự đặc biệt</small>
                            </div>

                            <div class="form-group">
                                <label>Xác nhận mật khẩu</label>
                                <div class="password-input">
                                    <input type="@(_showConfirmPassword ? "text" : "password")"
                                           @bind="_registerConfirmPassword"
                                           placeholder="Nhập lại mật khẩu"
                                           class="form-control"
                                           required />
                                    <button type="button"
                                            class="password-toggle"
                                            @onclick="ToggleConfirmPassword">
                                        @if (_showConfirmPassword)
                                        {
                                            <span>Ẩn</span>
                                        }
                                        else
                                        {
                                            <span>Hiện</span>
                                        }
                                    </button>
                                </div>
                            </div>

                            <button type="submit" class="btn-submit" disabled="@_registerLoading">
                                @(_registerLoading ? "Đang đăng ký..." : "Đăng ký")
                            </button>
                        </form>
                    }
                </div>
            </div>
        </div>

        <!-- Right Side - Info -->
        <div class="auth-right">
            <div class="auth-right-content">
                <h2>⚽ SportZone</h2>
                <p>Nền tảng đặt sân thể thao hàng đầu</p>
                <ul class="feature-list">
                    <li>✅ Đặt sân dễ dàng, nhanh chóng</li>
                    <li>✅ Thanh toán an toàn, bảo mật</li>
                    <li>✅ Hỗ trợ 24/7</li>
                    <li>✅ Nhiều lựa chọn sân đa dạng</li>
                </ul>
            </div>
        </div>
    </div>
</div>

@code {
    private string _activeTab = "signin";
    private string _email = "";
    private string _password = "";
    private bool _rememberMe = false;
    private bool _showPassword = false;
    private bool _loading = false;

    // Registration fields
    private string _registerRoleName = "";
    private string _registerName = "";
    private string _registerPhone = "";
    private string _registerEmail = "";
    private string _registerPassword = "";
    private string _registerConfirmPassword = "";
    private bool _showRegisterPassword = false;
    private bool _showConfirmPassword = false;
    private bool _registerLoading = false;
    private string _registerErrorMessage = "";
    private string _registerSuccessMessage = "";

    private void SetActiveTab(string tab)
    {
        _activeTab = tab;
        // Clear messages when switching tabs
        _registerErrorMessage = "";
        _registerSuccessMessage = "";
    }

    private void TogglePassword()
    {
        _showPassword = !_showPassword;
    }

    private void ToggleRegisterPassword()
    {
        _showRegisterPassword = !_showRegisterPassword;
    }

    private void ToggleConfirmPassword()
    {
        _showConfirmPassword = !_showConfirmPassword;
    }

    private void ShowForgotPassword()
    {
        // TODO: Implement forgot password modal
    }

    private async Task HandleSignIn()
    {
        if (string.IsNullOrWhiteSpace(_email) || string.IsNullOrWhiteSpace(_password))
        {
            return;
        }

        _loading = true;
        StateHasChanged();

        try
        {
            // TODO: Implement actual login logic
            // For now, simulate a delay
            await Task.Delay(1000);
            
            // Navigate to homepage or dashboard
            NavigationManager.NavigateTo("/", true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Login error: {ex.Message}");
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task HandleRegister()
    {
        _registerErrorMessage = "";
        _registerSuccessMessage = "";

        // Validation
        if (string.IsNullOrWhiteSpace(_registerRoleName))
        {
            _registerErrorMessage = "Vui lòng chọn vai trò";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(_registerName))
        {
            _registerErrorMessage = "Vui lòng nhập họ và tên";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(_registerPhone))
        {
            _registerErrorMessage = "Vui lòng nhập số điện thoại";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(_registerEmail))
        {
            _registerErrorMessage = "Vui lòng nhập email";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(_registerPassword))
        {
            _registerErrorMessage = "Vui lòng nhập mật khẩu";
            StateHasChanged();
            return;
        }

        if (_registerPassword != _registerConfirmPassword)
        {
            _registerErrorMessage = "Mật khẩu và xác nhận mật khẩu không khớp";
            StateHasChanged();
            return;
        }

        _registerLoading = true;
        StateHasChanged();

        try
        {
            var request = new RegisterRequest
            {
                RoleName = _registerRoleName,
                Name = _registerName,
                Phone = _registerPhone,
                Email = _registerEmail,
                Password = _registerPassword,
                ConfirmPassword = _registerConfirmPassword
            };

            var result = await AuthService.RegisterAsync(request);

            if (result.Success)
            {
                _registerSuccessMessage = result.Message;
                // Clear form
                _registerRoleName = "";
                _registerName = "";
                _registerPhone = "";
                _registerEmail = "";
                _registerPassword = "";
                _registerConfirmPassword = "";
                
                // Optionally switch to signin tab after successful registration
                await Task.Delay(2000);
                SetActiveTab("signin");
            }
            else
            {
                _registerErrorMessage = result.Message;
            }
        }
        catch (Exception ex)
        {
            _registerErrorMessage = $"Đã xảy ra lỗi: {ex.Message}";
            Console.WriteLine($"Registration error: {ex.Message}");
        }
        finally
        {
            _registerLoading = false;
            StateHasChanged();
        }
    }

    private void HandleGoogleLogin()
    {
        // TODO: Implement Google OAuth
        NavigationManager.NavigateTo("https://localhost:7057/api/Authentication/googlelogin", true);
    }
}
