@page "/payment"

<PageTitle>Thanh to√°n - SportZone</PageTitle>

<div class="payment-page">
    <div class="payment-header">
        <div>
            <h1>Thanh to√°n ƒë·∫∑t s√¢n</h1>
            <p>Ki·ªÉm tra l·∫°i th√¥ng tin ƒë·∫∑t s√¢n v√† ho√†n t·∫•t thanh to√°n an to√†n.</p>
        </div>
        <span class="payment-chip">B∆∞·ªõc 3/3</span>
    </div>

    <div class="payment-layout">
        <section class="booking-summary">
            <h2>T√≥m t·∫Øt ƒë·∫∑t s√¢n</h2>
            <div class="summary-card">
                <div class="summary-row">
                    <span class="summary-label">S√¢n</span>
                    <span class="summary-value">@_summary.FieldName</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">ƒê·ªãa ƒëi·ªÉm</span>
                    <span class="summary-value">@_summary.Location</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Ng√†y</span>
                    <span class="summary-value">@_summary.Date.ToString("dd/MM/yyyy")</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Khung gi·ªù</span>
                    <span class="summary-value">@_summary.TimeRange</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Th·ªùi l∆∞·ª£ng</span>
                    <span class="summary-value">@_summary.Duration</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">T·ªïng ti·ªÅn s√¢n</span>
                    <span class="summary-value">@FormatCurrency(_summary.FieldTotal)</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">D·ªãch v·ª• ƒëi k√®m</span>
                    <span class="summary-value">@FormatCurrency(_summary.ServiceTotal)</span>
                </div>
                <div class="summary-total">
                    <span>T·ªïng thanh to√°n</span>
                    <strong>@FormatCurrency(_summary.TotalAmount)</strong>
                </div>
            </div>

            <section class="help-card">
                <h3>H·ªó tr·ª£ nhanh</h3>
                <p>N·∫øu g·∫∑p kh√≥ khƒÉn khi thanh to√°n, h√£y li√™n h·ªá hotline <strong>1900 6868</strong> ho·∫∑c chat v·ªõi ch√∫ng t√¥i.</p>
            </section>
        </section>

        <section class="payment-form">
            <h2>Ph∆∞∆°ng th·ª©c thanh to√°n</h2>

            <div class="payment-methods">
                @foreach (var method in _methods)
                {
                    <button type="button"
                            class="method-card @(method.Code == _form.PaymentMethod ? "active" : string.Empty)"
                            @onclick="() => SelectMethod(method.Code)">
                        <span class="method-icon">@method.Icon</span>
                        <span class="method-info">
                            <strong>@method.Title</strong>
                            <small>@method.Description</small>
                        </span>
                    </button>
                }
            </div>

            <EditForm Model="_form" OnValidSubmit="SubmitPayment">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="form-grid">
                    <label>
                        <span>H·ªç v√† t√™n *</span>
                        <InputText @bind-Value="_form.CustomerName" required />
                    </label>
                    <label>
                        <span>S·ªë ƒëi·ªán tho·∫°i *</span>
                        <InputText @bind-Value="_form.Phone" required />
                    </label>
                    <label>
                        <span>Email</span>
                        <InputText @bind-Value="_form.Email" type="email" />
                    </label>
                    @if (_form.PaymentMethod == "credit")
                    {
                        <label>
                            <span>S·ªë th·∫ª</span>
                            <InputText @bind-Value="_form.CardNumber" maxlength="19" placeholder="1111 2222 3333 4444" />
                        </label>
                        <label>
                            <span>H·ªç t√™n ch·ªß th·∫ª</span>
                            <InputText @bind-Value="_form.CardHolder" />
                        </label>
                        <label>
                            <span>Ng√†y h·∫øt h·∫°n</span>
                            <InputText @bind-Value="_form.Expiry" placeholder="MM/YY" maxlength="5" />
                        </label>
                        <label>
                            <span>CVV</span>
                            <InputText @bind-Value="_form.Cvv" maxlength="4" />
                        </label>
                    }
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" disabled="_processing">
                        @_processing ? "ƒêang x·ª≠ l√Ω..." : "Thanh to√°n"
                    </button>
                    <p class="secure-note">Thanh to√°n ƒë∆∞·ª£c b·∫£o v·ªá b·ªüi SportZone. Ch√∫ng t√¥i kh√¥ng l∆∞u tr·ªØ th√¥ng tin th·∫ª c·ªßa b·∫°n.</p>
                </div>
            </EditForm>

            @if (!string.IsNullOrEmpty(_message))
            {
                <div class="payment-message">@_message</div>
            }
        </section>
    </div>
</div>

@code {
    private readonly BookingSummary _summary = new()
    {
        FieldName = "S√¢n b√≥ng mini A1",
        Location = "Khu th·ªÉ thao Trung t√¢m TDTT Qu·∫≠n 1, TP.HCM",
        Date = DateOnly.FromDateTime(DateTime.Today.AddDays(1)),
        TimeRange = "18:00 - 20:00",
        Duration = "120 ph√∫t",
        FieldTotal = 450_000m,
        ServiceTotal = 80_000m
    };

    private readonly List<PaymentMethod> _methods =
    [
        new("credit", "üí≥", "Th·∫ª t√≠n d·ª•ng/ghi n·ª£", "Thanh to√°n b·∫±ng th·∫ª Visa, MasterCard, JCB"),
        new("momo", "üì±", "V√≠ MoMo", "Qu√©t m√£ QR ho·∫∑c x√°c nh·∫≠n trong ·ª©ng d·ª•ng MoMo"),
        new("banking", "üè¶", "Chuy·ªÉn kho·∫£n ng√¢n h√†ng", "Chuy·ªÉn kho·∫£n tr·ª±c ti·∫øp qua ng√¢n h√†ng n·ªôi ƒë·ªãa")
    ];

    private PaymentForm _form = new()
    {
        CustomerName = "",
        Phone = "",
        Email = "",
        PaymentMethod = "credit"
    };

    private bool _processing;
    private string? _message;

    private decimal TotalAmount => _summary.TotalAmount;

    private IEnumerable<ServiceItem> FilteredServices => Array.Empty<ServiceItem>();

    private void SelectMethod(string method)
    {
        if (_form.PaymentMethod != method)
        {
            _form.PaymentMethod = method;
            _message = null;
        }
    }

    private async Task SubmitPayment()
    {
        _processing = true;
        _message = null;

        try
        {
            await Task.Delay(1200);
            _message = $"Thanh to√°n th√†nh c√¥ng {FormatCurrency(TotalAmount)} b·∫±ng ph∆∞∆°ng th·ª©c {GetMethodTitle(_form.PaymentMethod)}.";
        }
        finally
        {
            _processing = false;
        }
    }

    private string GetMethodTitle(string code)
        => _methods.FirstOrDefault(m => m.Code == code)?.Title ?? code;

    private static string FormatCurrency(decimal amount)
        => string.Format(System.Globalization.CultureInfo.GetCultureInfo("vi-VN"), "{0:N0}‚Ç´", amount);

    private sealed record BookingSummary
    {
        public string FieldName { get; init; } = string.Empty;
        public string Location { get; init; } = string.Empty;
        public DateOnly Date { get; init; }
        public string TimeRange { get; init; } = string.Empty;
        public string Duration { get; init; } = string.Empty;
        public decimal FieldTotal { get; init; }
        public decimal ServiceTotal { get; init; }
        public decimal TotalAmount => FieldTotal + ServiceTotal;
    }

    private sealed record PaymentMethod(string Code, string Icon, string Title, string Description);

    private sealed class PaymentForm
    {
        public string CustomerName { get; set; } = string.Empty;
        public string Phone { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string PaymentMethod { get; set; } = "credit";
        public string CardNumber { get; set; } = string.Empty;
        public string CardHolder { get; set; } = string.Empty;
        public string Expiry { get; set; } = string.Empty;
        public string Cvv { get; set; } = string.Empty;
    }

    private sealed record ServiceItem(string Name, decimal Price);
}
